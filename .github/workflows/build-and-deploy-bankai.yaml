name: Build & deploy 

on:
  workflow_call:
    inputs:    
      inputs_file:
        type: string
        required: false  
        default: ./k8s/cicd-inputs.yaml


env:
  deployment_file: ./k8s/deployment.yaml
  ingress_file: ./k8s/ingress.yaml
  rollout_timeout: 300       
  version_file: ./package.json  
  
permissions:
  contents: write

jobs:

  siren:
    runs-on: hero-arc-runners
    if: false
    steps:
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Pull Siren Image from Registry
        run: docker pull inputs.siren_image}

      - name: Run Siren Check
        run: |
          docker run --rm inputs.siren_image|| exit 1
        shell: bash

  version:
    outputs:
      version: ${{ steps.version.outputs.version }}
    runs-on: hero-arc-runners
    steps:
    
      - name: Checkout Caller Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}  # ✅ Pull the repository that triggered the workflow
          ref: ${{ github.ref }}  # ✅ Check out the same branch as the trigger
          token: ${{ secrets.GITHUB_TOKEN }}  # ✅ Use GitHub token for access

      - name: Load Inputs from YAML
        id: load-inputs
        uses: HerodotusDev/cicd/.github/actions/load-inputs@arc
        with:
          inputs_file: ${{ inputs.inputs_file }}

      - name: Extract Version
        uses: HerodotusDev/cicd/.github/actions/extract-version@arc
        id: version
        with:
          file: ${{ env.version_file }}   

  build-and-push-image:
    needs: [version]
    runs-on: hero-arc-runners
    strategy: 
        matrix:
            app: [api, daemon]
    steps:

      - name: Checkout Caller Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}  # ✅ Pull the repository that triggered the workflow
          ref: ${{ github.ref }}  # ✅ Check out the same branch as the trigger
          token: ${{ secrets.GITHUB_TOKEN }}  # ✅ Use GitHub token for access

      - name: Load Inputs from YAML
        id: load-inputs
        uses: HerodotusDev/cicd/.github/actions/load-inputs@arc
        with:
          inputs_file: ${{ inputs.inputs_file }}          

      - name: Build and push image
        uses: HerodotusDev/cicd/.github/actions/build-and-push-image@arc
        with:
          dockerhub_project: ${{ env.dockerhub_project }}
          app_name: ${{ env.app_name }}-${{ matrix.app }}
          version: ${{ needs.version.outputs.version }}
          docker_username: ${{ secrets.DOCKER_USERNAME }}
          docker_password: ${{ secrets.DOCKER_PASSWORD }}
          dockerfile: ./docker/Dockerfile.${{ matrix.app }}

  create-git-tag:
    needs: [version, build-and-push-image]
    runs-on: hero-arc-runners 
    steps:

      - name: Checkout Caller Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}
          ref: ${{ github.ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Load Inputs from YAML
        id: load-inputs
        uses: HerodotusDev/cicd/.github/actions/load-inputs@arc
        with:
          inputs_file: ${{ inputs.inputs_file }}

      - name: Create Git tag
        uses: HerodotusDev/cicd/.github/actions/create-git-tag@arc
        with:
          tag: ${{ needs.version.outputs.version }}
          token: ${{ secrets.GITHUB_TOKEN }}

  deploy-staging:
    needs: [version, create-git-tag, build-and-push-image]
    runs-on: hero-arc-runners
    strategy: 
        matrix:
            app: [api, daemon]    
    if: always()
    steps:      

      - name: Checkout Caller Repository
        uses: actions/checkout@v4
        with:
          repository: ${{ github.repository }}  # ✅ Pull the repository that triggered the workflow
          ref: ${{ github.ref }}  # ✅ Check out the same branch as the trigger
          token: ${{ secrets.GITHUB_TOKEN }}  # ✅ Use GitHub token for access    

      - name: Load Inputs from YAML
        id: load-inputs
        uses: HerodotusDev/cicd/.github/actions/load-inputs@arc
        with:
          inputs_file: ${{ inputs.inputs_file }}
          
      - name: Pull config from etcd
        uses: HerodotusDev/cicd/.github/actions/pull-etcd-config@arc
        if: ${{ env.pull_etcd_config == 'true' }}
        with:
          kube_config: ${{ secrets.KUBE_CONFIG }}
          namespace: ${{ env.namespace }}
          app_name: ${{ env.app_name }}-${{ matrix.app }}
          etcd_user: ${{ secrets.ETCD_USER }}
          etcd_password: ${{ secrets.ETCD_PASSWORD }}
          etcd_key: ${{ env.etcd_key}}



      - name: Deploy to Kubernetes
        uses: HerodotusDev/cicd/.github/actions/deploy-to-k8s@arc
        with:
          kube_config: ${{ secrets.KUBE_CONFIG }}
          namespace: ${{ env.namespace }}
          deployment_file: ./k8s/${{ env.app_name }}-${{ matrix.app }}.yaml
          ingress_file: ./k8s/${{ env.app_name }}-${{ matrix.app }}-ingress.yaml
          rollout_timeout: ${{ env.rollout_timeout }}
          image_tag: ${{ needs.version.outputs.version }}
          dockerhub_project: ${{ env.dockerhub_project }}
          app_name: ${{ env.app_name }}-${{ matrix.app }}