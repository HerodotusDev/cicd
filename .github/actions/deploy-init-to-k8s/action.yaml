# .github/actions/k8s-deploy/action.yml
name: "Deploy init pod on K8s"
description: "Updates and applies an init pod manifest, then waits for completion."
inputs:
  namespace:
    description: "Kubernetes namespace to deploy to."
    required: true
  pod_manifest:
    description: "Path to the init pod manifest file."
    required: true
  rollout_timeout:
    description: "Timeout in seconds for the init pod to reach Succeeded."
    required: false
    default: "500"
  image_tag:
    description: "Image tag to deploy."
    required: true
  dockerhub_project:
    description: "Docker Hub project or repository prefix."
    required: true
  app_name:
    description: "Application name (used for image and pod lookups)."
    required: true

runs:
  using: "composite"
  steps:
    - name: Set up kubectl
      uses: azure/setup-kubectl@v4
      with:
        version: "v1.32.0"

    - name: Update pod manifest image tag
      run: |
        if [ -f "${{ inputs.pod_manifest }}" ]; then
          sed -i "s|<IMAGE>|${{ inputs.dockerhub_project }}/${{ (github.ref_name != 'main-main' && github.ref_name != 'main') && 'stg-' || '' }}${{ inputs.app_name }}:${{ inputs.image_tag }}|g" "${{ inputs.pod_manifest }}"
        else
          echo "Manifest ${{ inputs.pod_manifest }} not found. Nothing to update."
        fi
      shell: bash

    - name: Delete pod if it exists
      run: |
        POD="${{ inputs.app_name }}"
        if kubectl get pod "$POD" -n "${{ inputs.namespace }}" > /dev/null 2>&1; then
          echo "Deleting pod $POD"
          kubectl delete pod "$POD" -n "${{ inputs.namespace }}"
        else
          echo "Pod $POD not found, skipping deletion."
        fi
      shell: bash

    - name: Apply init pod manifest if present
      run: |
        if [ -f "${{ inputs.pod_manifest }}" ]; then
          echo "Applying manifest ${{ inputs.pod_manifest }}"
          kubectl apply --namespace "${{ inputs.namespace }}" -f "${{ inputs.pod_manifest }}"
        else
          echo "Manifest ${{ inputs.pod_manifest }} not found. Skipping deployment."
        fi
      shell: bash

    - name: Wait for init pod completion
      run: |
        if [ -f "${{ inputs.pod_manifest }}" ]; then
          kubectl wait \
            --for=jsonpath='{.status.phase}'=Succeeded \
            pod/${{ inputs.app_name }} \
            --namespace "${{ inputs.namespace }}" \
            --timeout=${{ inputs.rollout_timeout }}s
        else
          echo "Manifest missing, skipping wait."
        fi
      shell: bash
